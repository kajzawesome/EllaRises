<%- include('../partials/header', { title: 'My Account' }) %>

<div class="admin-container">

  <% if (user.level === "M") { %>
  <aside class="admin-sidebar">
      <h3><span class="lang-en">Admin Tools</span><span class="lang-es">Herramientas Admin</span></h3>
      <a class="admin-btn" href="/admin/dashboard">Dashboard</a>
      <a class="admin-btn" href="/admin/add-event">Add Event/Program</a>
      <a class="admin-btn" href="/admin/manageevents">Manage Events</a>
      <a class="admin-btn" href="/admin/manageusers">Manage Users</a>
      <a class="admin-btn" href="/admin/survey-responses">Manage Surveys</a>
      <a class="admin-btn" href="/admin/managedonations">Manage Donations</a>
  </aside>
  <% } %>

  <main class="admin-main">

    <% if (success_message) { %>
      <div class="success"><%= success_message %></div>
    <% } %>

    <h2>My Account</h2>

    <!-- =============================== -->
    <!--      PARENT INFORMATION         -->
    <!-- =============================== -->
    <form action="/account/<%= parent.userid %>/update" method="POST" class="event-card">

      <h3>Parent Information</h3>

      <label>First Name</label>
      <input type="text" name="parentfirstname" value="<%= parent.parentfirstname %>" required>

      <label>Last Name</label>
      <input type="text" name="parentlastname" value="<%= parent.parentlastname %>" required>

      <label>Email</label>
      <input type="email" name="parentemail" value="<%= parent.parentemail %>" required>

      <label>Phone</label>
      <input type="text" name="parentphone" value="<%= parent.parentphone %>">

      <label>City</label>
      <input type="text" name="parentcity" value="<%= parent.parentcity %>">

      <label>State</label>
      <input type="text" name="parentstate" value="<%= parent.parentstate %>">

      <label>ZIP Code</label>
      <input type="text" name="parentzip" value="<%= parent.parentzip %>">

      <label>College</label>
      <input type="text" name="parentcollege" value="<%= parent.parentcollege %>">

      <label>Language Preference</label>
      <input type="text" name="languagepreference" value="<%= parent.languagepreference %>">

      <label>Scholarship Interest</label>
      <input type="text" name="scholarshipinterest" value="<%= parent.scholarshipinterest %>">

      <label>Tuition Agreement</label>
      <select name="tuitionagreement">
        <option value="true" <%= parent.tuitionagreement ? "selected" : "" %>>Yes</option>
        <option value="false" <%= !parent.tuitionagreement ? "selected" : "" %>>No</option>
      </select>

      <label>Medical Consent</label>
      <select name="medicalconsent">
        <option value="true" <%= parent.medicalconsent ? "selected" : "" %>>Yes</option>
        <option value="false" <%= !parent.medicalconsent ? "selected" : "" %>>No</option>
      </select>

      <label>Photo/Video Consent</label>
      <select name="photoconsent">
        <option value="true" <%= parent.photoconsent ? "selected" : "" %>>Yes</option>
        <option value="false" <%= !parent.photoconsent ? "selected" : "" %>>No</option>
      </select>

      <label>Agreement Date</label>
      <input type="date" name="agreementdate"
             value="<%= parent.agreementdate ? parent.agreementdate.toISOString().split('T')[0] : '' %>">

      <button class="edit-btn" type="submit" style="margin-top:20px;">
        Save Parent Information
      </button>
    </form>


    <!-- Add Child -->
    <a href="/account/<%= parent.parentid %>/participant/add"
       class="admin-btn" style="margin-top:20px; display:inline-block;">
      Add Child
    </a>


    <!-- =============================== -->
    <!--          CHILDREN LIST          -->
    <!-- =============================== -->
    <h3 style="margin-top:35px;">Children</h3>

    <% parent.participants.forEach(child => { %>

      <form action="/account/participant/<%= child.participantid %>/update-full"
            method="POST" class="event-card">

        <h3>Edit Child: <%= child.participantfirstname %> <%= child.participantlastname %></h3>

        <label>First Name</label>
        <input type="text" name="participantfirstname" value="<%= child.participantfirstname %>" required>

        <label>Last Name</label>
        <input type="text" name="participantlastname" value="<%= child.participantlastname %>" required>

        <label>Email</label>
        <input type="email" name="participantemail" value="<%= child.participantemail %>" required>

        <label>Date of Birth</label>
        <input type="date" name="participantdob"
               value="<%= child.participantdob ? child.participantdob.toISOString().split('T')[0] : "" %>">

        <label>Grade</label>
        <input type="text" name="participantgrade" value="<%= child.participantgrade %>">

        <label>School/Employer</label>
        <input type="text" name="participantschooloremployer"
               value="<%= child.participantschooloremployer %>">

        <label>Field of Interest</label>
        <input type="text" name="participantfieldofinterest"
               value="<%= child.participantfieldofinterest %>">

        <label>Instrument (Mariachi)</label>
        <input type="text" name="mariachiinstrumentinterest"
               value="<%= child.mariachiinstrumentinterest %>">

        <label>Instrument Experience</label>
        <input type="text" name="instrumentexperience"
               value="<%= child.instrumentexperience %>">

        <label>Graduation Status</label>
        <select name="graduationstatus">
          <option value="not started" <%= child.graduationstatus === "not started" ? "selected" : "" %>>Not Started</option>
          <option value="in progress" <%= child.graduationstatus === "in progress" ? "selected" : "" %>>In Progress</option>
          <option value="completed" <%= child.graduationstatus === "completed" ? "selected" : "" %>>Completed</option>
        </select>

        <button class="edit-btn" type="submit" style="margin-top:15px;">
          Save Child
        </button>

      </form>

      <!-- Delete Child -->
      <form action="/account/participant/<%= child.participantid %>/delete"
            method="POST"
            onsubmit="return confirm('Delete this child and all milestones?');">
        <button class="admin-btn danger-btn" type="submit">
          Delete Child
        </button>
      </form>


      <!-- =============================== -->
      <!--   UPCOMING EVENTS (STATUS)     -->
      <!-- =============================== -->
      <details class="event-card" style="margin-top:20px;">
        <summary><strong>Upcoming Events for <%= child.participantfirstname %></strong></summary>

        <% if (child.upcomingEvents.length > 0) { %>
          <% child.upcomingEvents.forEach(ev => { %>
            <form
              class="occ-edit-card"
              style="margin-bottom:10px;"
              method="POST"
              action="/account/participant/<%= child.participantid %>/event-status/<%= ev.registrationid %>"
            >
              <div>
                <strong><%= ev.eventname %></strong><br>
                <small>
                  <%= ev.eventdatestart ? ev.eventdatestart.toISOString().split('T')[0] : "" %>
                  @ <%= ev.eventtimestart %>
                </small>
              </div>

              <label style="margin-top:5px; display:block;">
                Status:
                <select name="registrationstatus">
                  <option value="Not attending"
                    <%= (!ev.registrationstatus || ev.registrationstatus === "Not attending") ? "selected" : "" %>>
                    Not attending
                  </option>
                  <option value="Planning to attend"
                    <%= ev.registrationstatus === "Planning to attend" ? "selected" : "" %>>
                    Planning to attend
                  </option>
                </select>
              </label>

              <button type="submit" class="edit-btn" style="margin-top:5px;">
                Save Status
              </button>
            </form>
          <% }) %>
        <% } else { %>
          <p style="margin-top:10px;">No upcoming events scheduled.</p>
        <% } %>

      </details>



      <!-- =============================== -->
      <!--        PAST UNSURVEYED          -->
      <!-- =============================== -->
      <details class="event-card" style="margin-top:20px;">
        <summary><strong>Past Surveys for <%= child.participantfirstname %></strong></summary>

        <% if (child.pastUnsurveyed.length > 0) { %>
          <% child.pastUnsurveyed.forEach(sv => { %>
            <div class="occ-edit-card" style="margin-bottom:10px;">

              <strong><%= sv.eventname %></strong><br>
              <small>
                <%= sv.eventdatestart ? sv.eventdatestart.toISOString().split('T')[0] : "" %>
                @ <%= sv.eventtimestart %>
              </small>

              <form method="GET" action="/survey/fill/<%= sv.registrationid %>">
                <button class="edit-btn" style="margin-top:5px;">
                  Complete Survey
                </button>
              </form>

            </div>
          <% }) %>
        <% } else { %>
          <p style="margin-top:10px;">No pending surveys for this child.</p>
        <% } %>

      </details>



      <!-- =============================== -->
      <!--           MILESTONES            -->
      <!-- =============================== -->

      <!-- (rest of your milestone code unchanged) -->

    <% }) %>

  </main>
</div>

<%- include('../partials/footer') %>