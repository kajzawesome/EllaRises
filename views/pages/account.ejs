<%- include('../partials/header', { title: 'My Account', user: user }) %>

<div class="admin-container">

  <% if (user.level === "M") { %>
  <aside class="admin-sidebar">
      <h3><span class="lang-en">Admin Tools</span><span class="lang-es">Herramientas Admin</span></h3>
      <a class="admin-btn" href="/admin/dashboard">Dashboard</a>
      <a class="admin-btn" href="/admin/add-event">Add Event/Program</a>
      <a class="admin-btn" href="/manageevents">Manage Events</a>
      <a class="admin-btn" href="/admin/manageusers">Manage Users</a>
      <a class="admin-btn" href="/admin/survey-responses">Manage Surveys</a>
      <a class="admin-btn" href="/admin/managedonations">Manage Donations</a>
  </aside>
  <% } %>

  <main class="admin-main">

    <% if (success_message) { %>
      <div class="success"><%= success_message %></div>
    <% } %>

    <h2>My Account</h2>

    <!-- =============================== -->
    <!--      PARENT INFORMATION         -->
    <!-- =============================== -->
    
    <form action="/account/<%= parent.userid %>/update" method="POST" class="account-card">

      <h3 class="section-title">Parent Information</h3>

      <div class="account-grid-2">

        <div>
          <label>First Name</label>
          <input type="text" name="parentfirstname" value="<%= parent.parentfirstname %>" required>
        </div>

        <div>
          <label>Last Name</label>
          <input type="text" name="parentlastname" value="<%= parent.parentlastname %>" required>
        </div>

        <div>
          <label>Email</label>
          <input type="email" name="parentemail" value="<%= parent.parentemail %>" required>
        </div>

        <div>
          <label>Phone</label>
          <input type="text" name="parentphone" value="<%= parent.parentphone %>">
        </div>

        <div>
          <label>City</label>
          <input type="text" name="parentcity" value="<%= parent.parentcity %>">
        </div>

        <div>
          <label>State</label>
          <input type="text" name="parentstate" value="<%= parent.parentstate %>">
        </div>

        <div>
          <label>ZIP Code</label>
          <input type="text" name="parentzip" value="<%= parent.parentzip %>">
        </div>

        <div>
          <label>College</label>
          <input type="text" name="parentcollege" value="<%= parent.parentcollege %>">
        </div>

        <div>
          <label>Language Preference</label>
          <input type="text" name="languagepreference" value="<%= parent.languagepreference %>">
        </div>

        <div>
          <label>Scholarship Interest</label>
          <input type="text" name="scholarshipinterest" value="<%= parent.scholarshipinterest %>">
        </div>

        <div>
          <label>Tuition Agreement</label>
          <select name="tuitionagreement">
            <option value="true" <%= parent.tuitionagreement ? "selected" : "" %>>Yes</option>
            <option value="false" <%= !parent.tuitionagreement ? "selected" : "" %>>No</option>
          </select>
        </div>

        <div>
          <label>Medical Consent</label>
          <select name="medicalconsent">
            <option value="true" <%= parent.medicalconsent ? "selected" : "" %>>Yes</option>
            <option value="false" <%= !parent.medicalconsent ? "selected" : "" %>>No</option>
          </select>
        </div>

        <div>
          <label>Photo/Video Consent</label>
          <select name="photoconsent">
            <option value="true" <%= parent.photoconsent ? "selected" : "" %>>Yes</option>
            <option value="false" <%= !parent.photoconsent ? "selected" : "" %>>No</option>
          </select>
        </div>

        <div>
          <label>Agreement Date</label>
          <input type="date" name="agreementdate"
            value="<%= parent.agreementdate ? parent.agreementdate.toISOString().split('T')[0] : '' %>">
        </div>

      </div>

      <button class="primary-btn save-btn" type="submit">Save Parent Information</button>
    </form>

    <!-- Add Child Button -->
    <div class="page-container">
    <a href="/account/<%= parent.parentid %>/participant/add" class="add-child-btn">
      Add Child
    </a>
    </div>
    <!-- ===================================== -->
    <!--               CHILDREN               -->
    <!-- ===================================== -->
    <div class="page-container">
    <h3 style="margin-top:35px;">Children</h3>
    </div>

    <% parent.participants.forEach(child => { %>

      <!-- CHILD EDIT FORM -->
      <form action="/account/participant/<%= child.participantid %>/update-full"
            method="POST" class="event-card">

        <h3>Edit Child: <%= child.participantfirstname %> <%= child.participantlastname %></h3>

        <div class="account-grid-2">

          <div>
            <label>First Name</label>
            <input type="text" name="participantfirstname" value="<%= child.participantfirstname %>" required>
          </div>

          <div>
            <label>Last Name</label>
            <input type="text" name="participantlastname" value="<%= child.participantlastname %>" required>
          </div>

          <div>
            <label>Email</label>
            <input type="email" name="participantemail" value="<%= child.participantemail %>" required>
          </div>

          <div>
            <label>Date of Birth</label>
            <input type="date" name="participantdob"
              value="<%= child.participantdob ? child.participantdob.toISOString().split('T')[0] : '' %>">
          </div>

          <div>
            <label>Grade</label>
            <input type="text" name="participantgrade" value="<%= child.participantgrade %>">
          </div>

          <div>
            <label>School/Employer</label>
            <input type="text" name="participantschooloremployer" value="<%= child.participantschooloremployer %>">
          </div>

          <div>
            <label>Field of Interest</label>
            <input type="text" name="participantfieldofinterest" value="<%= child.participantfieldofinterest %>">
          </div>

          <div>
            <label>Instrument (Mariachi)</label>
            <input type="text" name="mariachiinstrumentinterest" value="<%= child.mariachiinstrumentinterest %>">
          </div>

          <div>
            <label>Instrument Experience</label>
            <input type="text" name="instrumentexperience" value="<%= child.instrumentexperience %>">
          </div>

          <div>
            <label>Graduation Status</label>
            <select name="graduationstatus">
              <option value="not started" <%= child.graduationstatus === "not started" ? "selected" : "" %>>Not Started</option>
              <option value="in progress" <%= child.graduationstatus === "in progress" ? "selected" : "" %>>In Progress</option>
              <option value="completed" <%= child.graduationstatus === "completed" ? "selected" : "" %>>Completed</option>
            </select>
          </div>

        </div>

        <button class="account-save-btn" type="submit">Save Child</button>
      </form>

      <!-- Delete Child -->
      <form action="/account/participant/<%= child.participantid %>/delete"
            method="POST"
            onsubmit="return confirm('Delete this child and all milestones?');">
        <button class="danger-btn child-delete-btn" type="submit">Delete Child</button>
      </form>

      <!-- =============================== -->
      <!--           UPCOMING EVENTS       -->
      <!-- =============================== -->
      <details class="event-card" style="margin-top:20px;">
        <summary><strong>Upcoming Events for <%= child.participantfirstname %></strong></summary>

        <% if (child.upcomingEvents.length > 0) { %>

          <% child.upcomingEvents.forEach(ev => { %>

            <form class="occ-edit-card"
                  method="POST"
                  action="/account/participant/<%= child.participantid %>/event-status/<%= ev.registrationid %>">

              <div>
                <strong><%= ev.eventname %></strong><br>
                <small><%= ev.eventdatestart ? ev.eventdatestart.toISOString().split('T')[0] : '' %>
                  @ <%= ev.eventtimestart %></small>
              </div>

              <label style="margin-top:5px;">
                Status:
                <select name="registrationstatus">
                  <option value="Not attending"
                    <%= (!ev.registrationstatus || ev.registrationstatus === "Not attending") ? "selected" : "" %>>
                    Not attending
                  </option>
                  <option value="Planning to attend"
                    <%= ev.registrationstatus === "Planning to attend" ? "selected" : "" %>>
                    Planning to attend
                  </option>
                </select>
              </label>

              <button type="submit" class="edit-btn" style="margin-top:5px;">Save Status</button>

            </form>

          <% }) %>

        <% } else { %>
          <p>No upcoming events.</p>
        <% } %>

      </details>

      <!-- =============================== -->
      <!--        PAST UNSURVEYED         -->
      <!-- =============================== -->
      <details class="event-card" style="margin-top:20px;">
        <summary><strong>Past Surveys for <%= child.participantfirstname %></strong></summary>

        <% if (child.pastUnsurveyed.length > 0) { %>

          <% child.pastUnsurveyed.forEach(sv => { %>

            <div class="occ-edit-card" style="margin-bottom:10px;">
              <strong><%= sv.eventname %></strong><br>
              <small><%= sv.eventdatestart ? sv.eventdatestart.toISOString().split('T')[0] : '' %>
                @ <%= sv.eventtimestart %></small>

              <form method="GET" action="/survey/fill/<%= sv.registrationid %>">
                <button class="edit-btn" style="margin-top:5px;">Complete Survey</button>
              </form>
            </div>

          <% }) %>

        <% } else { %>
          <p>No pending surveys.</p>
        <% } %>

      </details>

      <!-- =============================== -->
      <!--           MILESTONES            -->
      <!-- =============================== -->
      <details class="event-card" style="margin-top:20px;">
        <summary><strong>Milestones for <%= child.participantfirstname %></strong></summary>

        <% if (child.milestones && child.milestones.length > 0) { %>

          <% child.milestones.forEach(m => { %>

            <form action="/account/participant/<%= child.participantid %>/milestones/<%= m.milestoneid %>/update"
                  method="POST"
                  class="compact-card"
                  style="margin-bottom:15px;">

              <h4>Edit Milestone</h4>

              <div class="compact-grid">

                <div>
                  <label>Title</label>
                  <input type="text" name="milestonetitle"
                        value="<%= m.milestonetitle %>" required>
                </div>

                <div>
                  <label>Date</label>
                  <input type="date" name="milestonedate"
                        value="<%= m.milestonedate ? m.milestonedate.toISOString().split('T')[0] : '' %>"
                        required>
                </div>

                <div style="grid-column: span 2;">
                  <label>Status</label>
                  <select name="milestonestatus" required>
                    <option value="Not Started" <%= m.milestonestatus === "Not Started" ? "selected" : "" %>>Not Started</option>
                    <option value="In Progress" <%= m.milestonestatus === "In Progress" ? "selected" : "" %>>In Progress</option>
                    <option value="Completed" <%= m.milestonestatus === "Completed" ? "selected" : "" %>>Completed</option>
                    <option value="Deferred" <%= m.milestonestatus === "Deferred" ? "selected" : "" %>>Deferred</option>
                  </select>
                </div>

              </div>

              <div style="display:flex; gap:10px; margin-top:10px;">
                <button type="submit" class="edit-btn compact-btn">Save</button>
              </div>

            </form>  <!-- âœ… update form ends here -->

            <!-- DELETE FORM (separate form, but NOT nested!) -->
            <form action="/account/participant/<%= child.participantid %>/milestones/<%= m.milestoneid %>/delete"
                  method="POST"
                  onsubmit="return confirm('Delete this milestone?');">
              <button class="danger-btn compact-btn" type="submit">Delete</button>
            </form>

          <% }) %>

        <% } else { %>
          <p>No milestones yet.</p>
        <% } %>

        <a href="/account/participant/<%= child.participantid %>/milestones/add"
           class="admin-btn compact-btn"
           style="margin-top:10px; display:inline-block;">
           Add Milestone
        </a>

      </details>

    <% }) %>

  </main>
</div>

<%- include('../partials/footer') %>