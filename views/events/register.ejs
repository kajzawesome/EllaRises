<%- include('../partials/header', { title: title }) %>

<title><%= title || "Event Registration" %></title>

<div class="register-page">

    <h1>
        <span class="lang-en"><%= title || 'Register' %></span>
        <span class="lang-es"><%= title_es || 'Registrarse' %></span>
    </h1>

    <!-- =============================== -->
    <!-- SUCCESS / SYSTEM MESSAGES -->
    <!-- =============================== -->
    <% if (msg) { %>
        <div class="alert-success">
            <%= msg %>
        </div>
    <% } %>

    <% if (user) { %>

        <!-- ================================ -->
        <!--           PAST EVENTS            -->
        <!-- ================================ -->
        <% if (pastItems && pastItems.length > 0) { %>
            <section class="past-items">
                <h2>
                    <span class="lang-en">Past <%= type %></span>
                    <span class="lang-es"><%= type_es %> Pasados</span>
                </h2>

                <div class="item-container">
                    <% pastItems.forEach(item => { %>
                        <div class="item-card">
                            <h3><%= item.name %></h3>
                            <p><%= item.date.toLocaleDateString() %></p>

                            <span class="completed">
                                <span class="lang-en">Event Completed</span>
                                <span class="lang-es">Evento Completado</span>
                            </span>
                        </div>
                    <% }) %>
                </div>
            </section>
        <% } %>

        <!-- ================================ -->
        <!--      UPCOMING REGISTERED         -->
        <!-- ================================ -->
        <% if (upcomingRegistered && upcomingRegistered.length > 0) { %>
            <section class="upcoming-registered">
                <h2>
                    <span class="lang-en">Your Upcoming <%= type %></span>
                    <span class="lang-es">Tus Próximos <%= type_es %></span>
                </h2>

                <div class="item-container">
                    <% upcomingRegistered.forEach(item => { %>
                        <div class="item-card">
                            <h3><%= item.name %></h3>
                            <p><%= item.date.toLocaleDateString() %></p>

                            <span class="registered">
                                <span class="lang-en">Registered</span>
                                <span class="lang-es">Registrado</span>
                            </span>
                        </div>
                    <% }) %>
                </div>
            </section>
        <% } %>

        <!-- ================================ -->
        <!--       AVAILABLE EVENTS           -->
        <!-- ================================ -->
        <% if (availableItems && availableItems.length > 0) { %>
            <section class="available-items">
                <h2>
                    <span class="lang-en">Available <%= type %></span>
                    <span class="lang-es"><%= type_es %> Disponibles</span>
                </h2>

                <div class="item-container">
                    <% availableItems.forEach(item => { %>
                        <div class="item-card">
                            <h3><%= item.name %></h3>
                            <p><%= item.date.toLocaleDateString() %></p>

                            <!-- Modal Trigger -->
                            <button type="button"
                                    onclick="openChildModal('<%= item.id %>')">
                                <span class="lang-en">Register</span>
                                <span class="lang-es">Registrarse</span>
                            </button>
                        </div>
                    <% }) %>
                </div>
            </section>
        <% } else { %>

            <p>
                <span class="lang-en">No upcoming <%= type %> available.</span>
                <span class="lang-es">No hay <%= type_es %> disponibles próximamente.</span>
            </p>

        <% } %>

    <% } else { %>
        <!-- ================================ -->
        <!--      NOT LOGGED IN MESSAGE       -->
        <!-- ================================ -->
        <p>
            <span class="lang-en">
                Please <a href="/login?context=enroll">login</a> to view and register for <%= type %>.
            </span>
            <span class="lang-es">
                Por favor <a href="/login?context=enroll">inicie sesión</a> para ver y registrarse en <%= type_es %>.
            </span>
        </p>
    <% } %>

</div>



<!-- ====================================== -->
<!--        CHILD SELECT MODAL             -->
<!-- ====================================== -->
<div id="childModal" class="modal hidden">
    <div class="modal-content">
        <h3>
            <span class="lang-en">Select a Child</span>
            <span class="lang-es">Seleccione una Hija</span>
        </h3>

        <% if (children && children.length > 0) { %>

            <form id="childSelectForm" method="POST">

                <label>
                    <span class="lang-en">Choose Child:</span>
                    <span class="lang-es">Escoger Hija:</span>
                </label>

                <!-- DROPDOWN OF ONLY UNREGISTERED CHILDREN -->
                <select name="child_email" required>
                    <% 
                    children.forEach(child => { 
                        const isRegistered = upcomingRegistered.some(reg =>
                            reg.childEmails && reg.childEmails.includes(child.participantemail)
                        );

                        if (!isRegistered) {
                    %>
                        <option value="<%= child.participantemail %>">
                            <%= child.participantfirstname %> <%= child.participantlastname %>
                        </option>
                    <% 
                        }
                    }); 
                    %>
                </select>

                <button type="submit">
                    <span class="lang-en">Continue</span>
                    <span class="lang-es">Continuar</span>
                </button>

            </form>

        <% } else { %>
            <p>
                <span class="lang-en">No children found under your account.</span>
                <span class="lang-es">No hay hijas registradas en su cuenta.</span>
            </p>
        <% } %>

        <button class="cancel" type="button" onclick="closeChildModal()">
            <span class="lang-en">Cancel</span>
            <span class="lang-es">Cancelar</span>
        </button>
    </div>
</div>


<script>
    function openChildModal(eventId) {
        const modal = document.getElementById("childModal");
        const form = document.getElementById("childSelectForm");

        form.action = `/events/register/${eventId}`;
        modal.classList.remove("hidden");
    }

    function closeChildModal() {
        document.getElementById("childModal").classList.add("hidden");
    }
</script>

<%- include('../partials/footer') %>
