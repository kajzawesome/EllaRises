<%- include('../partials/header', { title: 'Donations' , user: user, lang: lang }) %>

<div class="admin-container">
    <aside class="admin-sidebar">
        <h3><span class="lang-en">Admin Tools</span><span class="lang-es">Herramientas Admin</span></h3>
        <a class="admin-btn" href="/admin/dashboard"> <span class="lang-en">Dashboard</span><span class="lang-es">Panel</span></a>
        <a class="admin-btn" href="/admin/addEvent"> <span class="lang-en">Add Event/Program</span><span class="lang-es">Agregar Evento/Programa</span></a>
        <a class="admin-btn" href="/admin/manageevents"> <span class="lang-en">Manage Events</span><span class="lang-es">Administrar Eventos</span></a>
        <a class="admin-btn" href="/admin/manageusers"> <span class="lang-en">Manage Users</span><span class="lang-es">Administrar Usuarios</span></a>
        <a class="admin-btn" href="/admin/managedonations"> <span class="lang-en">Manage Donations</span><span class="lang-es">Administrar Donaciones</span></a>
    </aside>

    <main class="admin-main">
        <section>
            <h2><span class="lang-en">Donations</span><span class="lang-es">Donaciones</span></h2>

            <!-- Flash messages -->
            <% if (success_message) { %>
                <div class="flash-message success"><%= success_message %></div>
            <% } %>
            <% if (error_message) { %>
                <div class="flash-message error"><%= error_message %></div>
            <% } %>

            <div style="margin-bottom:16px;">
                <a class="button" href="/admin/donations/export-csv"><span class="lang-en">Export CSV</span><span class="lang-es">Exportar CSV</span></a>
                <span style="margin-left:16px; font-weight:700;"><span class="lang-en">Total:</span><span class="lang-es">Total:</span> $<%= total || '0.00' %></span>
            </div>

            <!-- Filter Form -->
            <form method="GET" action="/admin/managedonations" class="donation-filters" style="margin-bottom:16px;">
                <fieldset>
                    <legend>Filter Donations</legend>

                    <label>
                        Start Date:
                        <input type="date" name="startDate" value="<%= filters.startDate || '' %>">
                    </label>

                    <label>
                        End Date:
                        <input type="date" name="endDate" value="<%= filters.endDate || '' %>">
                    </label>

                    <label>
                        Period:
                        <select name="period">
                            <option value="">All</option>
                            <option value="week" <%= filters.period === 'week' ? 'selected' : '' %>>Past Week</option>
                            <option value="month" <%= filters.period === 'month' ? 'selected' : '' %>>Past Month</option>
                            <option value="year" <%= filters.period === 'year' ? 'selected' : '' %>>Past Year</option>
                        </select>
                    </label>

                    <label>
                        Min Amount:
                        <input type="number" step="0.01" name="minAmount" value="<%= filters.minAmount || '' %>">
                    </label>

                    <label>
                        Max Amount:
                        <input type="number" step="0.01" name="maxAmount" value="<%= filters.maxAmount || '' %>">
                    </label>

                    <button type="submit">Apply Filters</button>
                    <a href="/admin/managedonations" class="button" style="margin-left:8px;">Reset Filters</a>
                </fieldset>
            </form>

            <% if (donations && donations.length) { %>
                <table style="width:100%; border-collapse:collapse;">
                    <thead>
                        <tr style="background:#f2f2f2; text-align:left;">
                            <th><span class="lang-en">Donor</span><span class="lang-es">Donante</span></th>
                            <th><span class="lang-en">Donor Email</span><span class="lang-es">Correo Electrónico</span></th>
                            <th><span class="lang-en">Amount</span><span class="lang-es">Cantidad</span></th>
                            <th><span class="lang-en">Donation Date</span><span class="lang-es">Fecha</span></th>
                            <th><span class="lang-en">Message</span><span class="lang-es">Mensaje</span></th>
                            <th><span class="lang-en">Actions</span><span class="lang-es">Acciones</span></th>
                        </tr>
                    </thead>
                    <tbody>
                        <% donations.forEach(d=> { %>
                            <tr>
                                <td><%= d.donor_name || 'Anonymous' %></td>
                                <td><%= d.donor_email %></td>
                                <td>$<%= d.amount %></td>
                                <td><%= d.date %></td>
                                <td><%= d.notes || '—' %></td>
                                <td>
                                    <form method="POST" action="/admin/managedonations/send-thankyou">
                                        <input type="hidden" name="donorEmail" value="<%= d.donor_email %>">
                                        <input type="hidden" name="donorName" value="<%= d.donor_name %>">
                                        <input type="hidden" name="amount" value="<%= d.amount %>">
                                        <button type="submit">Send Thank You</button>
                                    </form>
                                </td>
                            </tr>
                        <% }) %>
                    </tbody>
                </table>
            <% } else { %>
                <p><span class="lang-en">No donations recorded yet.</span><span class="lang-es">No hay donaciones registradas.</span></p>
            <% } %>
        </section>
    </main>
</div>

<%- include('../partials/footer') %>