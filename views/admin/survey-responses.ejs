<%- include('../partials/header', { title: 'Survey Responses', user: user, lang: lang }) %>

<div class="admin-container">
  
  <!-- Sidebar -->
  <aside class="admin-sidebar">
    <h3><%= lang === 'es' ? 'Herramientas Admin' : 'Admin Tools' %></h3>
    <a class="admin-btn" href="/admin/dashboard"><%= lang === 'es' ? 'Panel' : 'Dashboard' %></a>
    <a class="admin-btn" href="/admin/addEvent"><%= lang === 'es' ? 'Agregar Evento/Programa' : 'Add Event/Program' %></a>
    <a class="admin-btn" href="/admin/manageevents"><%= lang === 'es' ? 'Administrar Eventos' : 'Manage Events' %></a>
    <a class="admin-btn" href="/admin/manageusers"><%= lang === 'es' ? 'Administrar Usuarios' : 'Manage Users' %></a>
    <a class="admin-btn" href="/admin/surveys"><%= lang === 'es' ? 'Administrar Encuestas' : 'Manage Surveys' %></a>
    <a class="admin-btn" href="/admin/managedonations"><%= lang === 'es' ? 'Administrar Donaciones' : 'Manage Donations' %></a>
  </aside>

  <main class="admin-main">
    <section>
      <h2><%= lang === 'es' ? 'Respuestas de Encuesta' : 'Survey Responses' %></h2>

      <!-- Filters -->
      <div style="margin-bottom:18px;">
        <form method="GET" action="/admin/surveys">
          <!-- Event Filter -->
          <label for="filterValue"><%= lang === 'es' ? 'Filtrar por Evento:' : 'Filter by Event:' %></label>
          <select name="filterValue" id="filterValue">
            <option value=""><%= lang === 'es' ? 'Todos los Eventos' : 'All Events' %></option>
            <% if (filterOptions) { 
                 filterOptions.forEach(f => { %>
                   <option value="<%= f.id %>" <%= filterBy == f.id ? 'selected' : '' %>>
                     <%= lang === 'es' ? f.label_es : f.label_en %>
                   </option>
            <% }) } %>
          </select>

          <!-- Numeric Score Filter -->
          <label for="scoreValue"><%= lang === 'es' ? 'Filtrar por Puntaje:' : 'Filter by Score:' %></label>
          <select name="scoreOperator" id="scoreOperator">
            <option value=">="><%= lang === 'es' ? 'Mayor o igual' : 'Greater or equal' %></option>
            <option value="<="><%= lang === 'es' ? 'Menor o igual' : 'Less or equal' %></option>
            <option value="="><%= lang === 'es' ? 'Igual' : 'Equal' %></option>
          </select>
          <input type="number" name="scoreValue" placeholder="<%= lang === 'es' ? 'Puntaje' : 'Score' %>" value="<%= typeof scoreValue !== 'undefined' ? scoreValue : '' %>">

          <button class="button" type="submit"><%= lang === 'es' ? 'Filtrar' : 'Filter' %></button>
        </form>
      </div>

      <% if (responses && responses.length) { %>
        <!-- Average Overall Score -->
        <p style="margin-bottom:12px;">
          <%= lang === 'es' ? 'Promedio Puntaje General:' : 'Average Overall Score:' %> 
          <strong>
            <%= (responses.reduce((sum,r)=>sum + r.SurveyOverallScore,0)/responses.length).toFixed(2) %>
          </strong>
        </p>

        <table style="width:100%; border-collapse:collapse;">
          <thead>
            <tr style="text-align:left; background:#f2f2f2;">
              <th>ID</th>
              <th><%= lang === 'es' ? 'Participante' : 'Participant' %></th>
              <th><%= lang === 'es' ? 'Evento' : 'Event' %></th>
              <th><%= lang === 'es' ? 'Tipo' : 'Type' %></th>
              <th><%= lang === 'es' ? 'Descripción' : 'Description' %></th>
              <th><%= lang === 'es' ? 'Ubicación' : 'Location' %></th>
              <th><%= lang === 'es' ? 'Satisfacción' : 'Satisfaction' %></th>
              <th><%= lang === 'es' ? 'Utilidad' : 'Usefulness' %></th>
              <th><%= lang === 'es' ? 'Instructor' : 'Instructor' %></th>
              <th><%= lang === 'es' ? 'Recomendación' : 'Recommendation' %></th>
              <th><%= lang === 'es' ? 'General' : 'Overall' %></th>
              <th><%= lang === 'es' ? 'Comentarios' : 'Comments' %></th>
              <th><%= lang === 'es' ? 'Enviada' : 'Submitted' %></th>
            </tr>
          </thead>
          <tbody>
            <% responses.forEach(r => { %>
              <tr>
                <td><%= r.id %></td>
                <td><%= r.user_label %></td>
                <td><%= r.eventname %></td>
                <td><%= r.eventtype %></td>
                <td><%= r.eventdescription %></td>
                <td><%= r.eventlocation %></td>
                <td><%= r.SurveySatisfactionScore %></td>
                <td><%= r.SurveyUsefulnessScore %></td>
                <td><%= r.SurveyInstructorScore %></td>
                <td><%= r.SurveyRecommendationScore %></td>
                <td><%= r.SurveyOverallScore %></td>
                <td><%= r.SurveyComments || '—' %></td>
                <td><%= r.SurveySubmissionDate %> <%= r.SurveySubmissionTime %></td>
              </tr>
            <% }) %>
          </tbody>
        </table>
      <% } else { %>
        <p><%= lang === 'es' ? 'No hay respuestas aún.' : 'No survey responses yet.' %></p>
      <% } %>
    </section>
  </main>
</div>

<%- include('../partials/footer') %>