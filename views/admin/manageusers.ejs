<%- include('../partials/header', { title: 'Manage Users' }) %>

<title><%= title || "Manage Users" %></title>

<div class="admin-page">
    <h1 class="page-title">Manage Users</h1>

    <!-- Sidebar -->
    <aside class="admin-sidebar">
        <h3><span class="lang-en">Admin Tools</span><span class="lang-es">Herramientas Admin</span></h3>
        <a class="admin-btn" href="/admin/dashboard"> <span class="lang-en">Dashboard</span><span class="lang-es">Panel</span></a>
        <a class="admin-btn" href="/admin/addEvent"> <span class="lang-en">Add Event/Program</span><span class="lang-es">Agregar Evento/Programa</span></a>
        <a class="admin-btn" href="/admin/manageevents"> <span class="lang-en">Manage Events</span><span class="lang-es">Administrar Eventos</span></a>
        <a class="admin-btn" href="/admin/manageusers"> <span class="lang-en">Manage Users</span><span class="lang-es">Administrar Usuarios</span></a>
        <a class="admin-btn" href="/admin/surveys"> <span class="lang-en">Manage Surveys</span><span class="lang-es">Administrar Encuestas</span></a>
        <a class="admin-btn" href="/admin/managedonations"> <span class="lang-en">Manage Donations</span><span class="lang-es">Administrar Donaciones</span></a>
    </aside>

    <!-- Error Message -->
    <% if (error_message) { %>
        <div class="alert error"><%= error_message %></div>
    <% } %> 

    <!-- ============ PARENT ACCOUNTS ============ -->
    <section>
        <h2>Parent Accounts</h2>

        <% if (parents.length === 0) { %>
            <div class="alert info">No parent accounts found.</div>
        <% } else { %>
            <% parents.forEach(p => { %>
                <div class="parent-card">

                    <div class="parent-header">
                        <!-- Parent name links to their profile -->
                        <div class="parent-name">
                            <a href="/admin/user/<%= p.userid %>">
                                <%= p.parentfirstname %> <%= p.parentlastname %>
                            </a>
                        </div>

                        <!-- Toggle button -->
                        <% if (p.children && p.children.length > 0) { %>
                            <button
                                id="child-<%= p.parentid %>-toggle"
                                class="child-toggle"
                                onclick="toggleChildren('child-<%= p.parentid %>')">
                                Show Children ▼
                            </button>
                        <% } %>
                    </div>

                    <% if (p.children && p.children.length > 0) { %>
                        <ul class="child-list" id="child-<%= p.parentid %>">

                            <% p.children.forEach(c => { %>
                                <li class="child-card">
                                    <strong><%= c.participantfirstname %> <%= c.participantlastname %></strong>
                                    <br>
                                    <span><strong>Interest:</strong> <%= c.participantfieldofinterest %></span>
                                    <br>
                                    <span><strong>City:</strong> <%= c.participantcity %></span>
                                    <br>
                                    <span><strong>Email:</strong> <%= c.participantemail %></span>
                                    <br>
                                    <!-- Link to milestones -->
                                    <form method="POST" action="/admin/user/<%= p.userid %>/participant/<%= c.participantid %>/milestones" style="display:inline;">
                                        <button type="submit" class="button">View Milestones</button>
                                    </form>
                                </li>
                            <% }) %>

                        </ul>
                    <% } else { %>
                        <p style="margin-top: 10px; color: #888;">No participants linked.</p>
                    <% } %>

                </div>
            <% }) %>
        <% } %>
    </section>
</div>

<script>
function toggleChildren(id) {
    const list = document.getElementById(id);
    const btn = document.getElementById(id + "-toggle");

    // read ACTUAL CSS display state
    const isHidden = window.getComputedStyle(list).display === "none";

    if (isHidden) {
        list.style.display = "block";
        btn.innerHTML = "Hide Children ▲";
    } else {
        list.style.display = "none";
        btn.innerHTML = "Show Children ▼";
    }
}
</script>

<%- include('../partials/footer') %>    