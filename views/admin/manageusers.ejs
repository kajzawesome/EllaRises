<%- include('../partials/header', { title: 'Manage Users' }) %>

<title><%= title || "Manage Users" %></title>

<div class="admin-page">
    <h1 class="page-title">Manage Users</h1>

    <!-- Sidebar -->
    <aside class="admin-sidebar">
        <h3><span class="lang-en">Admin Tools</span><span class="lang-es">Herramientas Admin</span></h3>
        <a class="admin-btn" href="/admin/dashboard">Dashboard</a>
        <a class="admin-btn" href="/admin/add-event">Add Event/Program</a>
        <a class="admin-btn" href="/admin/manageevents">Manage Events</a>
        <a class="admin-btn" href="/admin/manageusers">Manage Users</a>
        <a class="admin-btn" href="/admin/surveys">Manage Surveys</a>
        <a class="admin-btn" href="/admin/managedonations">Manage Donations</a>
    </aside>

    <% if (error_message) { %>
        <div class="alert error"><%= error_message %></div>
    <% } %> 

    <!-- ============ PARENT ACCOUNTS ============ -->
    <section>
        <h2>Parent Accounts</h2>

        <% if (parents.length === 0) { %>
            <div class="alert info">No parent accounts found.</div>
        <% } else { %>
            <% parents.forEach(p => { %>

                <div class="parent-card">
                    <div class="parent-header">

                        <!-- Parent name links to their admin profile -->
                        <div class="parent-name">
                            <a href="/account/<%= p.userid %>">
                                <%= p.parentfirstname %> <%= p.parentlastname %>
                            </a>
                        </div>

                        <!-- Contact info -->
                        <div class="parent-info">
                            <span><strong>Email:</strong> <%= p.parentemail %></span><br>
                            <span><strong>Phone:</strong> <%= p.parentphone %></span><br>
                            <% if (p.parentcity) { %>
                                <span><strong>Location:</strong> <%= p.parentcity %>, <%= p.parentstate %> <%= p.parentzip %></span>
                            <% } %>
                        </div>

                        <% if (p.children && p.children.length > 0) { %>
                            <button
                                id="child-<%= p.parentid %>-toggle"
                                class="child-toggle"
                                onclick="toggleChildren('child-<%= p.parentid %>')">
                                Show Children ▼
                            </button>
                        <% } %>
                    </div>

                    <!-- Participant List -->
                    <% if (p.children && p.children.length > 0) { %>
                        <ul class="child-list" id="child-<%= p.parentid %>">

                            <% p.children.forEach(c => { %>
                                <li class="child-card">
                                    <strong>
                                        <%= c.participantfirstname %> <%= c.participantlastname %>
                                    </strong>
                                    <br>

                                    <span><strong>Email:</strong> <%= c.participantemail %></span><br>
                                    <span><strong>DOB:</strong> <%= c.participantdob %></span><br>

                                    <span><strong>Grade:</strong> <%= c.participantgrade %></span><br>
                                    <span><strong>School/Employer:</strong> <%= c.participantschooloremployer %></span><br>

                                    <span><strong>Programs:</strong> <%= c.participantfieldofinterest %></span><br>
                                    <span><strong>Mariachi Instrument:</strong> <%= c.mariachiinstrumentinterest || "N/A" %></span><br>
                                    <span><strong>Experience:</strong> <%= c.instrumentexperience %></span><br>

                                    <span><strong>Status:</strong> <%= c.graduationstatus %></span><br><br>

                                    <!-- Milestones button -->
                                    <form method="POST" action="/admin/user/<%= p.userid %>/participant/<%= c.participantid %>/milestones" style="display:inline;">
                                        <button type="submit" class="button">View Milestones</button>
                                    </form>
                                </li>
                            <% }) %>

                        </ul>

                    <% } else { %>
                        <p style="margin-top: 10px; color: #888;">No participants linked.</p>
                    <% } %>
                </div>

            <% }) %>
        <% } %>
    </section>
</div>

<script>
function toggleChildren(id) {
    const list = document.getElementById(id);
    const btn = document.getElementById(id + "-toggle");

    const isHidden = window.getComputedStyle(list).display === "none";

    if (isHidden) {
        list.style.display = "block";
        btn.innerHTML = "Hide Children ▲";
    } else {
        list.style.display = "none";
        btn.innerHTML = "Show Children ▼";
    }
}
</script>

<%- include('../partials/footer') %>